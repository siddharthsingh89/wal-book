<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Chapter 5 : Crash Recovery</title>


        <!-- Custom HTML head -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KVDQ13RXMY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KVDQ13RXMY');
</script>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="chapter-5-crash-recovery"><a class="header" href="#chapter-5-crash-recovery">Chapter 5: Crash Recovery</a></h1>
<p>When you first implement a Write-Ahead Log, you might think the hard part is done - after all, every change is recorded safely before it’s applied to data. But the <em>real</em> test of a WAL comes when the system crashes.</p>
<p>This chapter is all about recovery: how a database uses the WAL to restore itself to a consistent state after a crash. You’ll see how to reconstruct committed transactions, discard incomplete ones, and make sure no data is lost - all automatically, on restart.</p>
<hr />
<h2 id="step-1-why-crash-recovery-matters"><a class="header" href="#step-1-why-crash-recovery-matters">Step 1: Why Crash Recovery Matters</a></h2>
<p>Imagine your database is running smoothly, applying transactions and appending log records. Then suddenly the system crashes. When it comes back online, you have two kinds of persistent data:</p>
<ol>
<li><strong>Data files</strong> – may not include recent writes (since they’re buffered in memory).</li>
<li><strong>WAL file</strong> – includes a complete, durable record of all operations.</li>
</ol>
<p>That WAL is your lifeline. It remembers what the database <em>intended</em> to do, even if it didn’t finish doing it. Crash recovery’s job is to make sure those intentions are faithfully completed - or safely undone.</p>
<hr />
<h2 id="step-2-recovery-goals"><a class="header" href="#step-2-recovery-goals">Step 2: Recovery Goals</a></h2>
<p>Crash recovery must satisfy two of the four core database guarantees:</p>
<ul>
<li><strong>Durability:</strong> Committed transactions must survive crashes.</li>
<li><strong>Atomicity:</strong> Uncommitted transactions must be rolled back completely.</li>
</ul>
<p>To achieve this, our recovery logic will:</p>
<ol>
<li><strong>Redo</strong> the effects of committed transactions that weren’t fully written to disk.</li>
<li><strong>Undo</strong> the effects of incomplete or aborted transactions.</li>
</ol>
<p>You can think of recovery as a replay and rewind system - replay all good work, rewind anything half-done.</p>
<hr />
<h2 id="step-3-what-survives-a-crash"><a class="header" href="#step-3-what-survives-a-crash">Step 3: What Survives a Crash</a></h2>
<p>Let’s recap what persists across a crash:</p>
<ul>
<li>The <strong>WAL file</strong> on disk, flushed up to the last <code>fsync</code>.</li>
<li>The <strong>data files</strong>, which may be out of date.</li>
</ul>
<p>Everything else - the in-memory cache, dirty page map, and active transaction table - is gone.</p>
<p>When the system restarts, the recovery process will rebuild that lost in-memory state <em>by reading the WAL itself</em>.</p>
<hr />
<h2 id="step-4-the-recovery-process-overview"><a class="header" href="#step-4-the-recovery-process-overview">Step 4: The Recovery Process Overview</a></h2>
<p>We’ll use a simplified version of the ARIES algorithm, with three stages:</p>
<ol>
<li><strong>Analysis:</strong> Figure out which transactions were active and which pages might be dirty at crash time.</li>
<li><strong>Redo:</strong> Reapply changes for committed transactions to ensure durability.</li>
<li><strong>Undo:</strong> Roll back incomplete transactions to ensure atomicity.</li>
</ol>
<p>Here’s the pseudocode for our recovery:</p>
<pre><code class="language-text">recover():
    txTable = {}
    dirtyPages = {}

    # Phase 1: Analysis
    for record in WAL:
        update txTable based on record type
        mark dirty pages

    # Phase 2: Redo
    for record in WAL:
        if record.page.LSN &lt; record.LSN and record.txn is committed:
            apply(record)

    # Phase 3: Undo
    for record in reversed(WAL):
        if record.txn is uncommitted:
            undo(record)
</code></pre>
<hr />
<h2 id="step-5-the-analysis-phase"><a class="header" href="#step-5-the-analysis-phase">Step 5: The Analysis Phase</a></h2>
<p>The first step is scanning the WAL from the beginning to rebuild our <strong>transaction table</strong> and <strong>dirty page table</strong>.</p>
<p>Whenever you see:</p>
<ul>
<li><code>BEGIN_TXN</code> → Add transaction as <em>in-progress</em></li>
<li><code>COMMIT_TXN</code> → Mark as <em>committed</em></li>
<li><code>ABORT_TXN</code> → Mark as <em>aborted</em></li>
<li><code>UPDATE</code> → Record that the page is dirty and associate it with that transaction</li>
</ul>
<p>By the end of this scan, you know exactly which transactions were incomplete when the system crashed.</p>
<p><strong>Example:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Txn ID</th><th>State</th><th>Last LSN</th><th>Dirty Pages</th></tr></thead><tbody>
<tr><td>1</td><td>committed</td><td>152</td><td>[P3, P5]</td></tr>
<tr><td>2</td><td>in-progress</td><td>177</td><td>[P8]</td></tr>
</tbody></table>
</div>
<p>Now we’re ready to restore data to a consistent state.</p>
<hr />
<h2 id="step-6-redo-phase"><a class="header" href="#step-6-redo-phase">Step 6: Redo Phase</a></h2>
<p>Redo ensures that <em>all committed transactions</em> are reflected in the data files.</p>
<p>For each WAL record:</p>
<ol>
<li>Read the page from disk.</li>
<li>Check the page’s stored <code>pageLSN</code> (the last log record applied to it).</li>
<li>If <code>pageLSN &lt; record.LSN</code>, it means this record wasn’t applied yet - so apply the update now.</li>
<li>Update the <code>pageLSN</code> to the record’s <code>LSN</code>.</li>
</ol>
<p>This process is <strong>idempotent</strong> - if you crash again during recovery, redoing the same records won’t double-apply changes.</p>
<hr />
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<p>Let’s say we have the following WAL log:</p>
<div class="table-wrapper"><table><thead><tr><th>LSN</th><th>Txn</th><th>Type</th><th>Page</th><th>Before</th><th>After</th></tr></thead><tbody>
<tr><td>100</td><td>1</td><td>BEGIN_TXN</td><td>-</td><td>-</td><td>-</td></tr>
<tr><td>110</td><td>1</td><td>UPDATE</td><td>P3</td><td>A</td><td>B</td></tr>
<tr><td>120</td><td>2</td><td>BEGIN_TXN</td><td>-</td><td>-</td><td>-</td></tr>
<tr><td>130</td><td>2</td><td>UPDATE</td><td>P5</td><td>X</td><td>Y</td></tr>
<tr><td>140</td><td>1</td><td>COMMIT_TXN</td><td>-</td><td>-</td><td>-</td></tr>
</tbody></table>
</div>
<p>Suppose a crash occurs right after record 130 (Txn 2’s update), before 140 is fully flushed.</p>
<p>On restart:</p>
<ul>
<li>Analysis: Txn 1 = committed, Txn 2 = in-progress.</li>
<li>Redo: Apply Txn 1’s update to P3 (if not already applied).</li>
<li>Undo: Roll back Txn 2’s change on P5.</li>
</ul>
<p>The end state is consistent:</p>
<pre><code>P3 = B  (committed)
P5 = X  (rolled back)
</code></pre>
<hr />
<h2 id="step-7-undo-phase"><a class="header" href="#step-7-undo-phase">Step 7: Undo Phase</a></h2>
<p>The undo phase is the cleanup crew.
We scan the WAL backward and reverse any changes made by uncommitted transactions.</p>
<p>For each record:</p>
<ul>
<li>If it belongs to an in-progress transaction, apply its <em>before-image</em> to restore the old value.</li>
<li>Optionally, write a <strong>compensation log record (CLR)</strong> indicating that this undo action has been logged. (Our minimal design can skip this for simplicity.)</li>
</ul>
<p>When all incomplete transactions are undone, atomicity is guaranteed.</p>
<hr />
<h2 id="step-8-checkpoints-optional-optimization"><a class="header" href="#step-8-checkpoints-optional-optimization">Step 8: Checkpoints (Optional Optimization)</a></h2>
<p>Reading the entire WAL on every restart works, but it can be slow.
To speed up recovery, databases write <strong>checkpoints</strong> periodically.</p>
<p>A checkpoint records:</p>
<ul>
<li>The list of active transactions</li>
<li>The list of dirty pages</li>
<li>The last flushed LSN</li>
</ul>
<p>When the system restarts, recovery can begin from the last checkpoint instead of from the start of the log.</p>
<p>Here’s what a minimal checkpoint record might look like:</p>
<pre><code class="language-json">{
  "type": "CHECKPOINT",
  "active_txns": [2, 3],
  "dirty_pages": ["P8", "P9"],
  "last_lsn": 150
}
</code></pre>
<hr />
<h2 id="step-9-implementing-recovery-in-code-c-example"><a class="header" href="#step-9-implementing-recovery-in-code-c-example">Step 9: Implementing Recovery in Code (C# Example)</a></h2>
<p>Below is a minimal conceptual version of the recovery logic.
It assumes you already have a <code>WALRecord</code> struct and a way to read pages from disk.</p>
<pre><code class="language-csharp">public class RecoveryManager
{
    private readonly IPageStore _pageStore;
    private readonly IEnumerable&lt;WALRecord&gt; _log;

    public RecoveryManager(IPageStore pageStore, IEnumerable&lt;WALRecord&gt; log)
    {
        _pageStore = pageStore;
        _log = log;
    }

    public void Recover()
    {
        var txState = new Dictionary&lt;long, string&gt;(); // txnId -&gt; state

        // Phase 1: Analysis
        foreach (var rec in _log)
        {
            switch (rec.Type)
            {
                case WALRecordType.Begin:
                    txState[rec.TxnId] = "active";
                    break;
                case WALRecordType.Commit:
                    txState[rec.TxnId] = "committed";
                    break;
                case WALRecordType.Abort:
                    txState[rec.TxnId] = "aborted";
                    break;
            }
        }

        // Phase 2: Redo
        foreach (var rec in _log)
        {
            if (rec.Type == WALRecordType.Update &amp;&amp;
                txState.TryGetValue(rec.TxnId, out var state) &amp;&amp;
                state == "committed")
            {
                var page = _pageStore.ReadPage(rec.PageId);
                if (page.LSN &lt; rec.LSN)
                {
                    page.Apply(rec.AfterImage);
                    page.LSN = rec.LSN;
                    _pageStore.WritePage(page);
                }
            }
        }

        // Phase 3: Undo
        foreach (var rec in _log.Reverse())
        {
            if (rec.Type == WALRecordType.Update &amp;&amp;
                txState.TryGetValue(rec.TxnId, out var state) &amp;&amp;
                state == "active")
            {
                var page = _pageStore.ReadPage(rec.PageId);
                page.Apply(rec.BeforeImage);
                _pageStore.WritePage(page);
            }
        }

        Console.WriteLine("Recovery complete!");
    }
}
</code></pre>
<p>This implementation is minimal but captures the essence:</p>
<ul>
<li>Replays committed work.</li>
<li>Reverses incomplete transactions.</li>
<li>Keeps idempotence through <code>page.LSN</code> checks.</li>
</ul>
<hr />
<h2 id="step-10-wrapping-up"><a class="header" href="#step-10-wrapping-up">Step 10: Wrapping Up</a></h2>
<p>Crash recovery completes the story that began with Write-Ahead Logging.
Together, they guarantee that your database can crash at <em>any</em> point and still come back consistent.</p>
<p>By now, your system:</p>
<ul>
<li>Writes intent before data (WAL).</li>
<li>Replays or rolls back intent after crashes (Recovery).</li>
</ul>
<p>In the next chapter, we’ll focus on <strong>checkpointing and log truncation</strong> - the final step in keeping your WAL lean, your recovery fast, and your storage healthy.</p>
<hr />

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch4_design_csharp.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="ch6_checkpoint.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch4_design_csharp.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="ch6_checkpoint.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
