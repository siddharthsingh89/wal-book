<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Chapter 2 : The Core Idea of WAL</title>


        <!-- Custom HTML head -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KVDQ13RXMY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KVDQ13RXMY');
</script>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="chapter-2-the-core-idea-of-write-ahead-logging"><a class="header" href="#chapter-2-the-core-idea-of-write-ahead-logging">Chapter 2: The Core Idea of Write-Ahead Logging</a></h1>
<p>When you use a database - whether you’re transferring money in an app, editing a document, or saving a game - you expect your data to stay safe, <strong>no matter what</strong>.
Even if the power goes out, your laptop crashes, or your phone dies midway, you want your data to come back intact when you restart.</p>
<p>But how does that actually happen?</p>
<p>That’s where <strong>Write-Ahead Logging (WAL)</strong> comes in - a clever technique that databases use to ensure that data isn’t lost or corrupted even in the face of failures.
Let’s understand the <em>core idea</em> behind it step by step.</p>
<hr />
<h2 id="1-the-problem-wal-solves"><a class="header" href="#1-the-problem-wal-solves">1. The Problem WAL Solves</a></h2>
<p>Imagine you’re building a banking app.
A user transfers ₹1000 from <strong>Account A</strong> to <strong>Account B</strong>.</p>
<p>You write some code like this:</p>
<pre><code class="language-sql">UPDATE accounts SET balance = balance - 1000 WHERE id = 'A';
UPDATE accounts SET balance = balance + 1000 WHERE id = 'B';
COMMIT;
</code></pre>
<p>Looks fine, right?</p>
<p>Now imagine the power goes out <strong>after</strong> the first line executes but <strong>before</strong> the second one does.
Account A has lost ₹1000, but Account B hasn’t received it yet.
Your database is now in an inconsistent state.</p>
<p>This kind of partial update is what <strong>WAL</strong> is designed to prevent.</p>
<p>It ensures that even if a crash happens halfway through an operation, the database can <strong>recover to a consistent state</strong> - either completing the transaction fully or rolling it back entirely.</p>
<hr />
<h2 id="2-the-naive-approach-and-its-limitations"><a class="header" href="#2-the-naive-approach-and-its-limitations">2. The Naive Approach and Its Limitations</a></h2>
<p>In theory, we could just <strong>write all changes directly to disk immediately</strong> to ensure they are durable.</p>
<p>But there’s a problem - disk I/O is <strong>slow</strong> compared to memory operations.</p>
<p>If every update required rewriting data files on disk synchronously, performance would tank.
To make matters worse, if the system crashes during that disk write, the data file could become partially updated (corrupted).</p>
<p>So we need something faster and safer - something that records <em>what we intend to do</em> before doing it.</p>
<hr />
<h2 id="3-the-key-idea-log-before-you-write"><a class="header" href="#3-the-key-idea-log-before-you-write">3. The Key Idea: Log Before You Write</a></h2>
<p>Here’s the golden rule of WAL:</p>
<blockquote>
<p><strong>Always write the intent of a change (to a log) before applying the change to the main data.</strong></p>
</blockquote>
<p>This means whenever the database wants to modify data, it follows this simple three-step process:</p>
<ol>
<li><strong>Create a log record</strong> that describes the change.
Example: “At time T, subtract 1000 from A, add 1000 to B.”</li>
<li><strong>Append that record to a log file</strong> on disk - <em>sequentially</em> (this is fast).</li>
<li><strong>Apply the change to the actual data file</strong> - possibly later, in batches.</li>
</ol>
<p>If a crash happens right after step 2 but before step 3, the log file still contains the record of what was intended.
When the system restarts, it can <strong>replay</strong> the log to restore the correct state.</p>
<p>Here’s a simple pseudo-code version:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn transfer(a: &amp;mut Account, b: &amp;mut Account, amount: i64) {
    // Step 1: create log entry
    let log_entry = format!("TRANSFER {} {} {}", a.id, b.id, amount);

    // Step 2: write log first (flush to disk)
    write_to_log(log_entry);

    // Step 3: apply to data
    a.balance -= amount;
    b.balance += amount;

    // Step 4: mark log as committed
    mark_log_committed();
}
<span class="boring">}</span></code></pre></pre>
<p>Notice that <strong>we never update the data until the log is safely on disk</strong>.</p>
<p>That’s the essence of “write-ahead.”</p>
<hr />
<h2 id="4-the-log-as-a-source-of-truth"><a class="header" href="#4-the-log-as-a-source-of-truth">4. The Log as a Source of Truth</a></h2>
<p>The WAL is typically a <strong>sequential file</strong> - an append-only record of every change the database plans to make.</p>
<p>Each record (or “log entry”) contains enough information to redo or undo an operation.</p>
<p>Example structure:</p>
<div class="table-wrapper"><table><thead><tr><th>Log Sequence Number (LSN)</th><th>Operation</th><th>Before Value</th><th>After Value</th><th>Page ID</th></tr></thead><tbody>
<tr><td>101</td><td>UPDATE</td><td>balance=5000</td><td>balance=4000</td><td>A</td></tr>
<tr><td>102</td><td>UPDATE</td><td>balance=2000</td><td>balance=3000</td><td>B</td></tr>
</tbody></table>
</div>
<p>Why is this efficient?</p>
<ul>
<li>Appending to a log file is a <strong>sequential write</strong> - disks and SSDs handle it extremely fast.</li>
<li>Updating the data file directly involves <strong>random I/O</strong>, which is much slower.</li>
<li>This means WAL gives you <strong>durability with high performance</strong>.</li>
</ul>
<p>In many databases (like PostgreSQL and SQLite), the log file is stored separately - often in a directory like <code>pg_wal/</code> or <code>journal/</code>.</p>
<hr />
<h2 id="5-crash-recovery-using-wal"><a class="header" href="#5-crash-recovery-using-wal">5. Crash Recovery Using WAL</a></h2>
<p>So what happens if the system crashes?</p>
<p>On restart, the database checks two things:</p>
<ol>
<li><strong>The log</strong> - what changes were intended or committed?</li>
<li><strong>The data files</strong> - what’s the current state on disk?</li>
</ol>
<p>It then performs two operations:</p>
<ul>
<li><strong>Redo:</strong> Reapply committed changes that weren’t fully written to the data files.</li>
<li><strong>Undo:</strong> Roll back uncommitted changes that were partially applied.</li>
</ul>
<p>Example:</p>
<p>Let’s say the last few WAL entries were:</p>
<pre><code>LSN 201: START TRANSACTION
LSN 202: UPDATE A -1000
LSN 203: UPDATE B +1000
LSN 204: COMMIT
</code></pre>
<p>If the system crashed before the data was flushed to disk, the WAL replay will read up to <code>LSN 204</code> (the COMMIT) and <strong>redo</strong> the operations to make sure both updates appear.</p>
<p>If it crashed before <code>COMMIT</code>, WAL ensures both are undone - maintaining atomicity.</p>
<hr />
<h2 id="6-benefits-of-wal"><a class="header" href="#6-benefits-of-wal">6. Benefits of WAL</a></h2>
<p>WAL gives databases several powerful advantages:</p>
<ul>
<li><strong>Durability</strong> – Once a log is written, data can always be recovered.</li>
<li><strong>Atomicity</strong> – Transactions either complete fully or not at all.</li>
<li><strong>Performance</strong> – Sequential writes are faster than random writes.</li>
<li><strong>Recovery</strong> – Easy crash recovery using redo/undo.</li>
<li><strong>Replication</strong> – Logs can be shipped to replicas for high availability.</li>
<li><strong>Checkpoints</strong> – Data files can be periodically synced with logs for faster startup.</li>
</ul>
<p>This is why almost every modern database - PostgreSQL, MySQL (InnoDB), SQLite, LevelDB, RocksDB, and more - uses some form of WAL.</p>
<hr />
<h2 id="7-real-world-examples"><a class="header" href="#7-real-world-examples">7. Real-world Examples</a></h2>
<p>Here’s how different systems implement WAL:</p>
<ul>
<li>
<p><strong>PostgreSQL:</strong>
Uses WAL segments (usually 16 MB files) stored in <code>pg_wal/</code>.
You can stream these logs to replicas using <strong>WAL shipping</strong>.
<a href="https://www.postgresql.org/docs/current/wal-intro.html">PostgreSQL WAL Docs →</a></p>
</li>
<li>
<p><strong>SQLite:</strong>
Uses a WAL journal file (<code>.wal</code>) for atomic commits.
You can even inspect it with tools like <code>sqlite3 mydb.db ".recover"</code>.
<a href="https://www.sqlite.org/wal.html">SQLite WAL Mode →</a></p>
</li>
<li>
<p><strong>RocksDB / LevelDB:</strong>
Use a write-ahead log (<code>MANIFEST</code> or <code>.log</code>) to record changes to key-value stores.
It helps rebuild the database after crashes without full re-compaction.</p>
</li>
</ul>
<p>Even modern file systems like <strong>ext4</strong> and <strong>NTFS</strong> internally use journaling - which is a form of WAL at the file-system level.</p>
<hr />
<h2 id="8-summary-and-key-takeaways"><a class="header" href="#8-summary-and-key-takeaways">8. Summary and Key Takeaways</a></h2>
<ul>
<li><strong>WAL’s core principle:</strong> <em>Log every change before applying it.</em></li>
<li>This ensures <strong>durability</strong>, <strong>atomicity</strong>, and <strong>fast recovery</strong>.</li>
<li>Logs are <strong>append-only</strong>, making writes efficient.</li>
<li>During recovery, WAL replays committed transactions and rolls back incomplete ones.</li>
<li>It’s the foundation for advanced database features like replication, checkpoints, and crash recovery.</li>
</ul>
<hr />
<blockquote>
<p><strong>Coming Next:</strong>
In the next chapter, we’ll open up the hood and look at the <strong>architecture of WAL</strong> - the actual components, buffer management, checkpoints, and how databases implement them efficiently.</p>
</blockquote>
<hr />

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch1_intro_to_durability.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="ch3_architecture.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch1_intro_to_durability.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="ch3_architecture.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
