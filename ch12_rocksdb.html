<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RocksDB WAL</title>


        <!-- Custom HTML head -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KVDQ13RXMY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KVDQ13RXMY');
</script>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="chapter-12-rocksdb-wal-and-recovery"><a class="header" href="#chapter-12-rocksdb-wal-and-recovery">Chapter 12: RocksDB WAL and Recovery</a></h1>
<hr />
<h2 id="1-introduction"><a class="header" href="#1-introduction"><strong>1. Introduction</strong></a></h2>
<p>RocksDB is a <strong>high-performance, embedded key–value store</strong> developed by Facebook (now Meta), built on top of Google’s LevelDB.
It’s optimized for <strong>SSD storage, write-intensive workloads, and low-latency access</strong>.</p>
<p>At its core, RocksDB uses a <strong>Log-Structured Merge Tree (LSM)</strong> architecture - a write-optimized design where:</p>
<ul>
<li>Writes are appended sequentially (fast!),</li>
<li>Reads use in-memory indexes and Bloom filters,</li>
<li>And background <strong>compaction</strong> merges data to maintain order.</li>
</ul>
<p>Durability in RocksDB is achieved through a <strong>Write-Ahead Log (WAL)</strong>, just like in traditional databases - but adapted to an LSM world.</p>
<blockquote>
<p>Reference: <a href="https://github.com/facebook/rocksdb/wiki/Write-Ahead-Log">RocksDB WAL Docs</a></p>
</blockquote>
<hr />
<h2 id="2-the-core-idea"><a class="header" href="#2-the-core-idea"><strong>2. The Core Idea</strong></a></h2>
<p>All writes in RocksDB go through two components:</p>
<pre><code>Client Write → WAL (log file) → MemTable → SSTables (via Compaction)
</code></pre>
<ul>
<li>The <strong>WAL</strong> ensures durability.</li>
<li>The <strong>MemTable</strong> (an in-memory skiplist) provides fast access to recent data.</li>
<li>When the MemTable fills up, it’s flushed to disk as an <strong>SSTable</strong> (Sorted String Table).</li>
</ul>
<p>This two-tier approach provides <strong>fast writes + crash recovery</strong>.</p>
<hr />
<h2 id="3-the-write-path"><a class="header" href="#3-the-write-path"><strong>3. The Write Path</strong></a></h2>
<p>Here’s the step-by-step lifecycle of a write in RocksDB:</p>
<pre><code>1. Client issues PUT("key", "value")
2. RocksDB appends the record to the WAL file
3. Write is acknowledged after fsync (durability)
4. The record is inserted into the MemTable
5. Once MemTable is full → flush to disk (SST)
6. Later: Compaction merges SSTs for optimization
</code></pre>
<h3 id="visual-flow"><a class="header" href="#visual-flow">Visual Flow</a></h3>
<pre><code>┌─────────────┐
│ Application │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ WAL (Log)   │  ← Durable
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ MemTable    │  ← In-memory, fast
└──────┬──────┘
       │ (flush)
       ▼
┌─────────────┐
│ SSTables    │  ← On-disk sorted runs
└─────────────┘
</code></pre>
<hr />
<h2 id="4-wal-file-format-and-management"><a class="header" href="#4-wal-file-format-and-management"><strong>4. WAL File Format and Management</strong></a></h2>
<p>Every RocksDB WAL file contains a sequence of <strong>records</strong>, each representing a batch of writes (WriteBatch).
Each record has:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td>CRC32C</td><td>Checksum</td></tr>
<tr><td>Size</td><td>Record length</td></tr>
<tr><td>Type</td><td>Record type (full, first, middle, last)</td></tr>
<tr><td>Data</td><td>The serialized write batch</td></tr>
</tbody></table>
</div>
<p><strong>Files:</strong></p>
<pre><code>00001.log
00002.log
...
MANIFEST-000003
</code></pre>
<p>Each WAL file corresponds to a specific <strong>log number</strong>, and RocksDB maintains metadata about active and obsolete logs.</p>
<hr />
<h2 id="5-c-example-writing-to-wal"><a class="header" href="#5-c-example-writing-to-wal"><strong>5. C++ Example: Writing to WAL</strong></a></h2>
<p>RocksDB’s public API automatically handles WAL writes internally.
However, here’s a minimal example:</p>
<pre><code class="language-cpp">#include "rocksdb/db.h"
#include "rocksdb/options.h"

using namespace rocksdb;

int main() {
    DB* db;
    Options options;
    options.create_if_missing = true;

    Status s = DB::Open(options, "/tmp/rocksdb_wal_demo", &amp;db);
    assert(s.ok());

    WriteOptions writeOptions;
    writeOptions.sync = true; // ensures WAL fsync
    db-&gt;Put(writeOptions, "user:1", "Alice");

    delete db;
}
</code></pre>
<p>Here:</p>
<ul>
<li><code>writeOptions.sync = true</code> forces a flush to the WAL before acknowledging the write.</li>
<li>If RocksDB crashes, it replays the WAL to reconstruct the MemTable.</li>
</ul>
<hr />
<h2 id="6-recovery-process"><a class="header" href="#6-recovery-process"><strong>6. Recovery Process</strong></a></h2>
<p>During startup:</p>
<ol>
<li>RocksDB scans the last checkpoint and log sequence numbers.</li>
<li>Finds any unflushed WAL files.</li>
<li>Replays WAL entries to reconstruct in-memory MemTables.</li>
<li>Resumes normal operation.</li>
</ol>
<p>Simplified from <a href="https://github.com/facebook/rocksdb/blob/main/db/db_impl_open.cc">db_impl/db_impl_open.cc</a>:</p>
<pre><code class="language-cpp">Status DBImpl::RecoverLogFiles() {
    for (auto log : logs_to_recover) {
        SequentialFileReader reader(log.file);
        while (ReadRecord(&amp;reader, &amp;record)) {
            WriteBatch batch(record);
            WriteBatchInternal::InsertInto(&amp;batch, memtable);
        }
    }
}
</code></pre>
<p>This ensures that all committed writes are replayed into the MemTable, exactly like <strong>PostgreSQL’s replay of WAL segments</strong> or <strong>InnoDB’s redo recovery</strong>.</p>
<hr />
<h2 id="7-flushing-and-checkpointing"><a class="header" href="#7-flushing-and-checkpointing"><strong>7. Flushing and Checkpointing</strong></a></h2>
<p>RocksDB performs <strong>flushing</strong> and <strong>checkpoints</strong> differently:</p>
<ul>
<li><strong>Flushing</strong>: Converts MemTable → SSTable.</li>
<li><strong>Checkpointing</strong>: Writes a consistent snapshot of the entire DB (via <code>Checkpoint::CreateCheckpoint()</code>).</li>
</ul>
<p>WAL files are deleted only after their corresponding MemTables are flushed and persisted.</p>
<pre><code class="language-cpp">Status DB::Flush(const FlushOptions&amp; options);
</code></pre>
<p>The process:</p>
<pre><code>WAL File → MemTable → Flush → SSTable → Remove old WAL
</code></pre>
<hr />
<h2 id="8-compaction-and-log-compaction"><a class="header" href="#8-compaction-and-log-compaction"><strong>8. Compaction and Log Compaction</strong></a></h2>
<p>RocksDB’s <strong>compaction</strong> process is a background merge of SST files to maintain sorted order and reclaim space.
It’s conceptually related to “log compaction” in Kafka - rewriting data to keep only the latest versions.</p>
<h3 id="levels-in-rocksdb"><a class="header" href="#levels-in-rocksdb"><strong>Levels in RocksDB:</strong></a></h3>
<pre><code>L0: Recent SSTs (from MemTables)
L1: Older, larger files
L2..Ln: Compact, sorted data
</code></pre>
<p>During compaction:</p>
<ul>
<li>Redundant key versions are dropped.</li>
<li>Deleted keys are purged.</li>
<li>Older SSTs are merged into newer ones.</li>
</ul>
<p>This keeps query performance fast and storage usage efficient.</p>
<hr />
<h2 id="9-performance-considerations"><a class="header" href="#9-performance-considerations"><strong>9. Performance Considerations</strong></a></h2>
<div class="table-wrapper"><table><thead><tr><th>Configuration</th><th>Description</th></tr></thead><tbody>
<tr><td><code>write_buffer_size</code></td><td>Controls MemTable size</td></tr>
<tr><td><code>max_write_buffer_number</code></td><td>Number of MemTables before flush</td></tr>
<tr><td><code>WAL_ttl_seconds</code></td><td>How long to keep WALs before deletion</td></tr>
<tr><td><code>WAL_size_limit_MB</code></td><td>Max total WAL size before force flush</td></tr>
<tr><td><code>max_background_flushes</code></td><td>Number of flush threads</td></tr>
</tbody></table>
</div>
<p><strong>Write latency</strong> in RocksDB is typically determined by:</p>
<ul>
<li>WAL fsync cost</li>
<li>MemTable lock contention</li>
<li>Background flush pressure</li>
</ul>
<p>For most workloads, RocksDB achieves <strong>&lt;1ms durability latency</strong> with async I/O and group commits.</p>
<hr />
<h2 id="10-group-commit-and-batching"><a class="header" href="#10-group-commit-and-batching"><strong>10. Group Commit and Batching</strong></a></h2>
<p>RocksDB batches multiple concurrent writes into a <strong>single WAL record</strong>, improving throughput:</p>
<pre><code class="language-cpp">Status DBImpl::WriteImpl(WriteOptions options, WriteBatch* updates) {
    Writer w(updates);
    writers_.push_back(&amp;w);
    if (writers_.size() &gt; 1) {
        // Wait for the leader writer
        w.wait();
    } else {
        // Leader writes all batches to WAL
        WriteBatch merged = MergePendingWrites();
        wal-&gt;Append(merged);
        fsync_if_needed();
        notify_followers();
    }
}
</code></pre>
<p>This is similar to <strong>InnoDB’s group commit mechanism</strong>.</p>
<hr />
<h2 id="11-wal-recycling-and-ttl"><a class="header" href="#11-wal-recycling-and-ttl"><strong>11. WAL Recycling and TTL</strong></a></h2>
<p>To avoid creating too many log files, RocksDB recycles WAL files:</p>
<pre><code class="language-cpp">options.recycle_log_file_num = 2;
</code></pre>
<p>When enabled, old WALs are truncated and reused, reducing filesystem overhead - a critical optimization for SSD endurance and cloud workloads.</p>
<hr />
<h2 id="12-example-manual-wal-replay"><a class="header" href="#12-example-manual-wal-replay"><strong>12. Example: Manual WAL Replay</strong></a></h2>
<p>RocksDB provides a lower-level API to read WALs manually for diagnostics or replication:</p>
<pre><code class="language-cpp">#include "rocksdb/transaction_log.h"

DB* db;
DB::Open(Options(), "/tmp/rocksdb_demo", &amp;db);

SequenceNumber start_seq = 0;
std::unique_ptr&lt;TransactionLogIterator&gt; it;
db-&gt;GetUpdatesSince(start_seq, &amp;it);

while (it-&gt;Valid()) {
    BatchResult batch = it-&gt;GetBatch();
    std::cout &lt;&lt; "Sequence: " &lt;&lt; batch.sequence &lt;&lt; std::endl;
    it-&gt;Next();
}
</code></pre>
<p>This feature is used by <strong>RocksDB Replication</strong>, <strong>MyRocks</strong>, and <strong>distributed storage systems</strong> to stream changes downstream - similar to PostgreSQL’s <code>WALReceiver</code>.</p>
<hr />
<h2 id="13-recovery-example-timeline"><a class="header" href="#13-recovery-example-timeline"><strong>13. Recovery Example Timeline</strong></a></h2>
<pre><code>Before crash:
  WAL: 00023.log
  MemTable: unflushed writes

After crash:
  On startup:
    → Detects 00023.log
    → Reads each WriteBatch
    → Reconstructs MemTable
    → Continues operation
</code></pre>
<p>This recovery process is extremely fast - often milliseconds - since logs are sequential.</p>
<hr />
<h2 id="14-comparison-with-other-systems"><a class="header" href="#14-comparison-with-other-systems"><strong>14. Comparison with Other Systems</strong></a></h2>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>RocksDB</th><th>InnoDB</th><th>PostgreSQL</th></tr></thead><tbody>
<tr><td>Storage model</td><td>LSM Tree</td><td>B+ Tree</td><td>Heap + B+ Index</td></tr>
<tr><td>WAL type</td><td>Append-only key-value logs</td><td>Page-level redo logs</td><td>Segment WAL</td></tr>
<tr><td>Checkpoint</td><td>Flush MemTable</td><td>Flush dirty pages</td><td>Checkpoint LSN</td></tr>
<tr><td>Undo/Redo separation</td><td>None (idempotent updates)</td><td>Both</td><td>Single WAL</td></tr>
<tr><td>Compaction</td><td>Background merge</td><td>Buffer flushing</td><td>None</td></tr>
<tr><td>Concurrency</td><td>Multi-threaded</td><td>Multi-threaded</td><td>Multi-process</td></tr>
<tr><td>Designed for</td><td>Embedded / SSD / Key-value</td><td>OLTP relational</td><td>OLTP relational</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="15-design-insights"><a class="header" href="#15-design-insights"><strong>15. Design Insights</strong></a></h2>
<ul>
<li><strong>Log-structured design</strong> turns random writes into sequential appends - perfect for SSDs.</li>
<li><strong>Compaction replaces checkpointing and vacuuming</strong>, simplifying recovery logic.</li>
<li><strong>Crash safety</strong> is simple - replay WALs, rebuild MemTables.</li>
<li><strong>No undo logs</strong> needed - LSM updates are idempotent.</li>
</ul>
<p>RocksDB’s design favors <strong>high throughput and low write amplification</strong> at the cost of higher background I/O (compaction).</p>
<hr />
<h2 id="16-references"><a class="header" href="#16-references"><strong>16. References</strong></a></h2>
<ul>
<li><a href="https://github.com/facebook/rocksdb/wiki/Write-Ahead-Log">RocksDB Wiki – Write-Ahead Log</a></li>
<li><a href="https://github.com/facebook/rocksdb/blob/main/db/db_impl_open.cc">RocksDB Source Code – db_impl/db_impl_open.cc</a></li>
<li><a href="https://github.com/facebook/rocksdb/wiki/Compaction">RocksDB Compaction Overview</a></li>
<li><a href="https://github.com/google/leveldb/blob/main/db/log_format.h">LevelDB Log Format</a></li>
<li><a href="https://github.com/facebook/mysql-5.6/wiki/MyRocks-Introduction">MyRocks Design Docs</a></li>
</ul>
<hr />
<h2 id="17-summary"><a class="header" href="#17-summary"><strong>17. Summary</strong></a></h2>
<p>RocksDB’s WAL is simple yet powerful - an <strong>append-only, sequential log</strong> that guarantees durability and fast recovery.
It fits naturally into the LSM design philosophy:
<strong>write fast, merge later</strong>.</p>
<p>By combining WAL + MemTable + Compaction, RocksDB achieves:</p>
<ul>
<li>High throughput,</li>
<li>Fast crash recovery,</li>
<li>Tunable durability,</li>
<li>And SSD-optimized performance.</li>
</ul>
<p>RocksDB’s design demonstrates how <strong>WAL principles evolve</strong> from page-based systems to log-structured, distributed storage - a natural evolution of durability mechanisms for modern data systems.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch11_innodb.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="ch13_lmdb.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch11_innodb.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="ch13_lmdb.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
